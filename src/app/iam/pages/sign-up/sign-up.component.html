<div class="auth-wrapper">

  <mat-card class="auth-card">


    <!-- Logo de la app -->
    <img src="/LogoHuellitasConectadasF.jpg" alt="Logo Huellitas Conectadas" />
    <!-- Bienvenida -->
    <div class="welcome-text">
      <h2>Create Account</h2>
      <p>Register to get started</p>
    </div>

  <mat-horizontal-stepper [linear]="true" #stepper>


    <!-- Paso 1: Cuenta -->
    <mat-step [stepControl]="accountFormGroup">
      <form [formGroup]="accountFormGroup">
        <ng-template matStepLabel>
          <span [ngClass]="{ 'active-label': stepper.selectedIndex === 0 }">Cuenta</span>
        </ng-template>

        <!-- Campos -->
        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Nombre de usuario</mat-label>
          <input matInput formControlName="username" required />

          <!-- Mostrar mientras el validador asíncrono está en curso -->
          <mat-hint class="custom-hint" *ngIf="accountFormGroup.get('username')?.pending">Comprobando disponibilidad...</mat-hint>

          <!-- Mostrar disponible sólo cuando no está pending, el campo tiene valor, no hay error y el usuario ya interactuó -->
          <mat-hint class="custom-hint available-hint" *ngIf="!accountFormGroup.get('username')?.pending && accountFormGroup.get('username')?.value && !accountFormGroup.get('username')?.hasError('required') && !accountFormGroup.get('username')?.hasError('usernameTaken') && (accountFormGroup.get('username')?.dirty || accountFormGroup.get('username')?.touched)">Nombre de usuario disponible</mat-hint>

          <mat-error class="custom-error" *ngIf="accountFormGroup.get('username')?.hasError('required')">
            El nombre de usuario es obligatorio
          </mat-error>
          <mat-error class="custom-error" *ngIf="accountFormGroup.get('username')?.hasError('usernameTaken')">
            Este nombre de usuario ya está en uso
          </mat-error>
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Contraseña</mat-label>
          <input matInput type="password" formControlName="password" required />
          <mat-error class="custom-error" *ngIf="accountFormGroup.get('password')?.hasError('required')">
            La contraseña es obligatoria
          </mat-error>
          <mat-error class="custom-error" *ngIf="accountFormGroup.get('password')?.hasError('minlength')">
            La contraseña debe tener al menos 8 caracteres
          </mat-error>
          <mat-error class="custom-error" *ngIf="accountFormGroup.get('password')?.hasError('weakPassword')">
            La contraseña debe incluir mayúscula, minúscula, número y carácter especial
          </mat-error>
        </mat-form-field>
        </div>

        <div class="step-actions">
          <button mat-raised-button color="primary" matStepperNext [disabled]="accountFormGroup.invalid">
            Siguiente
            <mat-icon style="margin-left: 8px;">arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Paso 2: Datos personales -->
    <mat-step [stepControl]="personalFormGroup">
      <form [formGroup]="personalFormGroup">
        <ng-template matStepLabel>
          <span [ngClass]="{ 'active-label': stepper.selectedIndex === 1 }">Datos personales</span>
        </ng-template>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Nombre completo</mat-label>
          <input matInput formControlName="name" required />
          <mat-error class="custom-error" *ngIf="personalFormGroup.get('name')?.hasError('required')">
            El nombre completo es obligatorio
          </mat-error>
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Correo electrónico</mat-label>
          <input matInput type="email" formControlName="email" required />

          <!-- Mensajes de ayuda/estado -->
          <mat-error class="custom-error" *ngIf="personalFormGroup.get('email')?.hasError('required')">
            El correo electrónico es obligatorio
          </mat-error>
          <mat-error class="custom-error" *ngIf="personalFormGroup.get('email')?.hasError('email')">
            Ingresa un correo válido
          </mat-error>
          <mat-error class="custom-error" *ngIf="personalFormGroup.get('email')?.hasError('emailTaken')">
            Ya hay una cuenta con ese correo
          </mat-error>
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Dirección</mat-label>
          <input matInput formControlName="address" required />
          <mat-error class="custom-error" *ngIf="personalFormGroup.get('address')?.hasError('required')">
            La dirección es obligatoria
          </mat-error>
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Rol</mat-label>
          <mat-select formControlName="role" required>
            <mat-option value="ADOPTER">Adoptante</mat-option>
            <mat-option value="SHELTER">Refugio</mat-option>
          </mat-select>
        </mat-form-field>
        </div>

        <div class="step-actions">
          <button mat-stroked-button color="primary" matStepperPrevious>
            <mat-icon style="margin-right: 8px;">arrow_back</mat-icon>
            Anterior
          </button>

          <button mat-raised-button color="primary" matStepperNext [disabled]="personalFormGroup.invalid">
            Siguiente
            <mat-icon style="margin-left: 8px;">arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Paso 3: Preferencias -->
    <mat-step [stepControl]="preferencesFormGroup">
      <form [formGroup]="preferencesFormGroup">
        <ng-template matStepLabel>
          <span [ngClass]="{ 'active-label': stepper.selectedIndex === 2 }">Preferencias</span>
        </ng-template>

        <!-- reemplazado: botón para abrir diálogo de métodos de pago -->
        <div class="form-field-wrapper">
          <div style="width:100%; max-width:480px;">
            <label style="display:block; margin-bottom:8px; font-weight:500;">Métodos de pago disponibles</label>
            <div class="payment-actions" style="display:flex; gap:8px; margin-bottom:8px;">
              <button mat-raised-button color="primary" class="app-primary" (click)="openPaymentDialog()">Configurar métodos de pago</button>
              <span *ngIf="preferencesFormGroup.get('paymentConfigured')?.value" class="payment-badge" style="margin-left:8px;">Configurado</span>
            </div>

            <div class="methods-list" *ngIf="paymentMethodsArray?.length">
              <mat-list>
                <mat-list-item *ngFor="let m of paymentMethodsArray">
                  <span class="payment-badge">{{ m.type }}</span>
                  <span style="margin-left:8px;">{{ m.label }}</span>
                </mat-list-item>
              </mat-list>
            </div>

            <mat-error class="custom-error" *ngIf="preferencesFormGroup.get('paymentConfigured')?.hasError('required') && (preferencesFormGroup.get('paymentConfigured')?.touched || preferencesFormGroup.get('paymentConfigured')?.dirty)">
              Debes presionar "Configurar métodos de pago" o elegir "Agregar más tarde" para continuar
            </mat-error>
          </div>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Preferencias de mascotas</mat-label>
          <input matInput formControlName="preferences" placeholder="Ej. Perros, Gatos" />
        </mat-form-field>
        </div>

        <div class="step-actions">
          <button mat-stroked-button color="primary" matStepperPrevious>
            <mat-icon style="margin-right: 8px;">arrow_back</mat-icon>
            Anterior
          </button>

          <button mat-raised-button color="primary" matStepperNext [disabled]="preferencesFormGroup.invalid">
            Siguiente
            <mat-icon style="margin-left: 8px;">arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Paso 4: Hogar y experiencia -->
    <mat-step [stepControl]="homeFormGroup">
      <form [formGroup]="homeFormGroup" (ngSubmit)="onSubmit()">
        <ng-template matStepLabel>
          <span [ngClass]="{ 'active-label': stepper.selectedIndex === 3 }">Hogar y experiencia</span>
        </ng-template>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Tipo de hogar</mat-label>
          <input matInput formControlName="homeType" placeholder="Ej. Casa con patio" />
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Capacidad máxima de mascotas</mat-label>
          <input matInput type="number" formControlName="capacity" min="1" />
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Animales actualmente disponibles</mat-label>
          <input matInput type="number" formControlName="animalsAvailable" min="0" />
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Foto de perfil (URL)</mat-label>
          <input matInput type="url" formControlName="profilePic" />
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Biografía</mat-label>
          <textarea matInput formControlName="bio" rows="3"></textarea>
        </mat-form-field>
        </div>

        <div class="form-field-wrapper">
        <mat-form-field appearance="fill">
          <mat-label>Experiencia previa</mat-label>
          <textarea matInput formControlName="previousExperience" rows="3"></textarea>
        </mat-form-field>
        </div>

        <div class="step-actions">
          <button mat-stroked-button color="primary" matStepperPrevious>
            <mat-icon style="margin-right: 8px;">arrow_back</mat-icon>
            Anterior
          </button>

          <button mat-raised-button color="primary" type="submit" [disabled]="homeFormGroup.invalid">
            Registrarme
            <mat-icon style="margin-left: 8px;">check_circle</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

  </mat-horizontal-stepper>
</mat-card>
</div>
